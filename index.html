<!DOCTYPE html>
<html>
    <head>
        <title>Immersal + Three.js Minimal Example</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- Three.js読み込み -->
        <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
        <!-- Immersal読み込み -->
        <script src="https://cdn.jsdelivr.net/npm/immersal-client@1.3.1/dist/immersal-client.min.js"></script>

        <style>
            body { margin: 0; overflow: hidden; }
            canvas, video { position: absolute; top: 0; left: 0; }
        </style>
    </head>

    <body>
        <script>
            let scene, camera, renderer, cube, client;

            async function init() {
                // Three.js初期化
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                // ライトとキューブを追加
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(0, 10, 10);
                scene.add(light);

                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
                cube = new THREE.Mesh(geometry, material);
                scene.add(cube);

                // Immersal初期化
                client = new ImmersalClient({
                    apiKey: 'ea0a08dc4fe2593d0c798a95ec791d67689114c20bea95c4d97603b1968d7278',
                    mapIds: ['130946'],
                    videoElement: null,
                    useDeviceOrientation: true,
                });

                await client.startCamera();
                animate();
                localizeLoop();
            }

            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }

            async function localizeLoop() {
                while(true) {
                    const result = await client.localize();
                    if(result.success) {
                        const pose = result.pose;

                        // カメラ位置と回転を更新
                        camera.position.set(pose.position.x, pose.position.y, pose.position.z);
                        camera.rotation.set(
                            THREE.MathUtils.degToRad(pose.position.x),
                            THREE.MathUtils.degToRad(pose.position.y),
                            THREE.MathUtils.degToRad(pose.position.z)
                        );
                    }
                    await new Primise(resolve => setTimeout(resolve, 500));
                }
            }
            init();
        </script>
    </body>
</html>